<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Metaball Liquid</title>
    <link href="https://fonts.googleapis.com/css2?family=Offside&family=Workbench&display=swap" rel="stylesheet">
    <style>
        html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#050505; font-family:'Offside', sans-serif; }
        #canvas-container { position:absolute; top:0; left:0; z-index:1; width:100%; height:100%; filter: blur(20px) contrast(1.5); }
        canvas { display:block; width:100%; height:100%; }
        .container { position:relative; z-index:2; text-align:center; color:#e8e8e8; top:50%; transform:translateY(-50%); width:100%; }
        h1 { font-family:'Workbench', serif; font-size:3rem; margin-bottom:1rem; }
        .note { font-size:1.2rem; margin-bottom:2rem; }
        .slider-group { display:inline-block; text-align:left; margin:0 10px; }
        .slider-group label { display:block; font-size:0.9rem; margin-bottom:4px; }
        .slider-group input[type=range] { width:150px; }
    </style>
</head>
<body>
<div id="canvas-container">
    <canvas id="c"></canvas>
</div>
<div class="container">
    <h1>Field-based metaball</h1>
    <p class="note">Threshold control produces gooey merging shapes.</p>
    <div id="controls"></div>
</div>
<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
let w,h;
function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
window.addEventListener('resize',resize);resize();

// particles influencing the scalar field
const particles=[
    {x:0.2,y:0.3,vx:0.01,vy:0.005,r:120},
    {x:0.7,y:0.6,vx:-0.008,vy:0.01,r:150},
    {x:0.5,y:0.2,vx:0.006,vy:-0.007,r:100},
    {x:0.3,y:0.8,vx:-0.005,vy:-0.006,r:130}
];

let threshold=1.0;
const controls=document.getElementById('controls');
const thrGroup=document.createElement('div');
thrGroup.className='slider-group';
const thrLabel=document.createElement('label');
thrLabel.textContent='Threshold';
const thrSlider=document.createElement('input');
thrSlider.type='range';thrSlider.min=0;thrSlider.max=3;thrSlider.step=0.01;thrSlider.value=threshold;
thrSlider.addEventListener('input',e=>{threshold=parseFloat(e.target.value);});
thrGroup.appendChild(thrLabel);thrGroup.appendChild(thrSlider);controls.appendChild(thrGroup);

function field(x,y){
    let sum=0;
    particles.forEach(p=>{
        const dx=x - p.x*w;
        const dy=y - p.y*h;
        const d2=dx*dx + dy*dy + 0.0001;
        sum += (p.r*p.r) / d2;
    });
    return sum;
}

function draw(){
    const img=ctx.createImageData(w,h);
    const data=img.data;
    for(let j=0;j<h;j++){
        for(let i=0;i<w;i++){
            const f=field(i,j);
            if(f>threshold){
                const idx=(j*w+i)*4;
                // colour based on field strength
                const hue = (f*10) % 360;
                const c = `hsl(${hue},80%,50%)`;
                // parse hsl to rgb via canvas trick
                ctx.fillStyle=c; ctx.fillRect(0,0,1,1);
                const px = ctx.getImageData(0,0,1,1).data;
                data[idx]=px[0]; data[idx+1]=px[1]; data[idx+2]=px[2]; data[idx+3]=255;
            }
        }
    }
    ctx.putImageData(img,0,0);
    // update particle positions
    particles.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        if(p.x<0) p.x+=1; if(p.x>1) p.x-=1;
        if(p.y<0) p.y+=1; if(p.y>1) p.y-=1;
    });
    requestAnimationFrame(draw);
}

// seed a tiny 1x1 pixel helper for color conversion
ctx.fillRect(0,0,1,1);

draw();
</script>
</body>
</html>